{
    email {$ACME_EMAIL}
    # debug
}

# Plain HTTP for healthcheck; everything else redirects to HTTPS on same host
:80 {
    @health path /health
    handle @health { respond "ok" 200 }
    redir https://{host}{uri}
}

# Catch-all HTTPS: issues certs on demand for whatever Host header hits you
:443 {
    tls {
        on_demand
        # Optional: prevent random domains from using your ACME quota:
        # ask {$ON_DEMAND_ASK}
    }

    root * /app/public

    # FrankenPHP runs PHP in-process (no php-fpm)
    php_server

    file_server
    encode zstd gzip

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer-when-downgrade"
    }
}
